# Fractionate Edge — NGINX Configuration
# On Windows: %USERPROFILE%\.fractionate\nginx\conf\nginx.conf
# On Linux/macOS: ~/.fractionate/nginx/conf/nginx.conf

worker_processes 1;

events {
    worker_connections 64;
}

http {
    server {
        listen 127.0.0.1:8080;  # CRITICAL: 127.0.0.1 only, NOT 0.0.0.0

        # CORS — lock to specific origin
        # For development, change to http://localhost:3000 or http://localhost:5173
        # For production, use https://edge.fractionate.ai
        set $cors_origin "https://edge.fractionate.ai";

        # Health check endpoint
        location /api/health {
            proxy_pass http://127.0.0.1:8081;
            add_header Access-Control-Allow-Origin $cors_origin always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type" always;

            if ($request_method = OPTIONS) {
                return 204;
            }
        }

        # All API routes → FastAPI
        location /api/ {
            proxy_pass http://127.0.0.1:8081;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_buffering off;           # Required for SSE streaming
            proxy_cache off;
            proxy_read_timeout 300s;       # Long timeout for model inference

            # File upload size limit (100MB for documents)
            client_max_body_size 100m;

            add_header Access-Control-Allow-Origin $cors_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            add_header Access-Control-Expose-Headers "Content-Type" always;

            if ($request_method = OPTIONS) {
                return 204;
            }
        }

        # Block everything else
        location / {
            return 404;
        }
    }
}
